<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入 Tailwind CSS 腳本 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <title>老董科學：自動登入與即時按讚</title>
    
    <!-- 核心 SEO 元素 -->
    <meta name="description" content="老董科學部落格，文章涵蓋宇宙理論、量子物理、數學進位制與手指運算術。在老之前搞懂科學！">
    <meta name="keywords" content="萬有理論, 迴圈量子引力, 弦理論, 牛頓, 愛因斯坦, 進位制, 手指運算術, 老董科學, Firebase, 登入, 按讚">
    <meta name="author" content="老董科學">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #eef2ff;
        }
        /* -- 角色對話框樣式 -- */
        .speaker-host { border-left: 4px solid #3b82f6; background-color: #eff6ff; }
        .speaker-newton { border-left: 4px solid #f97316; background-color: #fff7ed; }
        .speaker-einstein { border-left: 4px solid #10b981; background-color: #ecfdf5; }
        .speaker-quantum { border-left: 4px solid #6366f1; background-color: #eef2ff; }
        .speaker-string { border-left: 4px solid #ec4899; background-color: #fdf2f8; }

        /* -- 目錄連結樣式 -- */
        .article-link { transition: all 0.2s; cursor: pointer; }
        .article-link.active {
            color: #ffffff;
            background-color: #3b82f6;
            transform: scale(1.02);
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba[Image of (0, 0, 0, 0.1)];
        }
        .article-link:not(.active) { color: #4b5563; }
        .article-link:not(.active):hover { color: #1d4ed8; background-color: #e0f2fe; }

        /* -- 按讚動畫 -- */
        .like-button {
            transition: all 0.1s ease-in-out;
            transform-origin: center;
        }
        .liked-active {
            animation: pulse 0.3s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10 border-t-8 border-blue-600">
        
        <!-- HEADER -->
        <header class="mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2 tracking-tight text-center">
                🧠 老董科學：在老之前搞「董」！
            </h1>
            <p id="article-subtitle" class="text-lg text-gray-600 text-center border-b pb-4">
                <!-- 副標題將由 JS 動態更新 -->
            </p>

            <!-- 登入/意見回饋區域 (新結構) -->
            <div class="absolute top-0 right-0 sm:top-1/2 sm:-translate-y-1/2 flex flex-col sm:flex-row items-end sm:items-center space-y-1 sm:space-y-0 sm:space-x-3 mt-2 sm:mt-0">
                
                <!-- 登入狀態/按鈕容器 -->
                <div id="auth-status-container" class="text-sm font-semibold text-gray-600">
                    <div class="animate-pulse text-xs text-gray-400">登入狀態載入中...</div>
                </div>
                
                <!-- 意見回饋按鈕 -->
                <button onclick="openFeedbackModal()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-sm sm:text-base">
                    🚀 意見回饋
                </button>
            </div>
        </header>

        <!-- RESPONSIVE GRID LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-4 md:gap-8">

            <!-- COLUMN 1: SIDEBAR (文章目錄 - 分類) -->
            <aside class="md:col-span-1 mb-8 md:mb-0">
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200 sticky top-4">
                    <h2 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">
                        📚 文章目錄
                    </h2>
                    
                    <!-- 科學類文章 -->
                    <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">⚛️ 科學類 (宇宙與力)</h3>
                    <nav class="space-y-2">
                        <a href="#" id="link-1" onclick="loadArticle(1); return false;" 
                           class="article-link block py-1.5 px-3 rounded-lg text-sm">
                            <span class="font-bold">#1</span> 萬有理論：終極物理的兩大難題
                        </a>
                        <a href="#" id="link-2" onclick="loadArticle(2); return false;" 
                           class="article-link block py-1.5 px-3 rounded-lg text-sm">
                            <span class="font-bold">#2</span> 宇宙設計圖之戰：量子 vs. 弦
                        </a>
                        <a href="#" id="link-3" onclick="loadArticle(3); return false;" 
                           class="article-link block py-1.5 px-3 rounded-lg text-sm">
                            <span class="font-bold">#3</span> 引力大戰！牛頓 vs. 愛因斯坦
                        </a>
                    </nav>
                    
                    <!-- 數學類文章 -->
                    <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">📐 數學類 (數字與運算)</h3>
                    <nav class="space-y-2">
                        <a href="#" id="link-101" onclick="loadArticle(101); return false;" 
                           class="article-link block py-1.5 px-3 rounded-lg text-sm">
                            <span class="font-bold">#4</span> 手指頭的極限：超進化進位制
                        </a>
                        <a href="#" id="link-102" onclick="loadArticle(102); return false;"
                           class="article-link block py-1.5 px-3 rounded-lg text-sm">
                            <span class="font-medium">#5</span> 除以零的危機：為什麼無解？
                        </a>
                    </nav>

                </div>
            </aside>
            
            <!-- COLUMN 2: MAIN CONTENT (主內容區) -->
            <main id="main-content" class="md:col-span-3">
                <div class="text-center text-gray-500 pt-16">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">文章載入中...</p>
                </div>
            </main>
        </div>

        <!-- FOOTER (Full width) -->
        <footer class="mt-8 text-center text-gray-400 border-t pt-4">
            <p>&copy; 2025 **老董科學** | 網頁由 Google Gemini 建立與維護</p>
        </footer>

    </div>

    <!-- 意見回饋 Modal 彈出視窗 -->
    <div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg transform transition-transform duration-300 scale-95">
            
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-blue-600">📝 意見與改進建議</h2>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <p class="text-gray-600 mb-4 text-sm">您的寶貴建議是讓「老董科學」變得更酷的燃料！</p>

            <form id="feedback-form" onsubmit="sendFeedback(); return false;">
                <div class="mb-4">
                    <label for="name" id="name-label" class="block text-sm font-medium text-gray-700 mb-1">您的暱稱 (選填)</label>
                    <input type="text" id="name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="例如：熱愛科學的同學" autocomplete="off">
                </div>
                
                <div class="mb-6">
                    <label for="suggestion" class="block text-sm font-medium text-gray-700 mb-1">改進建議 (必填)</label>
                    <textarea id="suggestion" name="suggestion" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="告訴我哪裡可以改進，或者你希望下一篇是什麼主題！"></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg shadow-md transition duration-300 transform hover:scale-[1.01]">
                    ✉️ 開啟郵件客戶端送出
                </button>
                <p class="text-xs text-gray-400 mt-2 text-center">這將會使用您裝置上的郵件應用程式發送。</p>
            </form>

        </div>
    </div>
    
    <!-- 輕量 Toast 提示框 -->
    <div id="toast-container" class="fixed top-5 right-5 z-[9999] space-y-2"></div>

    <script type="module">
        // 導入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, runTransaction, getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** 郵件設定 (請替換為您的 Email 地址!) ***
        const USER_EMAIL = "placeholder@example.com"; 
        
        // 文章的閱讀順序
        const articleOrder = [1, 2, 3, 101, 102];

        // Firebase Global Variables (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 服務實例與狀態
        let app, db, auth;
        let userId = null; // 當前使用者 ID (null if not logged in)
        let isAuthReady = false; // 認證是否完成

        // Firestore 路徑定義 (使用公共路徑)
        const ARTICLE_METADATA_PATH = `artifacts/${appId}/public/data/blog_articles`;
        const USER_LIKES_PATH = `artifacts/${appId}/public/data/blog_likes`;

        // 即時監聽器的儲存物件
        let articleLikeUnsub = null;
        let userLikeUnsub = null;

        /**
         * 顯示暫時的提示框 (取代 alert)
         * @param {string} message - 提示訊息
         * @param {'info'|'success'|'error'} type - 提示類型
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.textContent = message;
            
            let bgColor = 'bg-gray-700';
            let icon = '💡';
            if (type === 'success') { bgColor = 'bg-green-500'; icon = '✅'; }
            if (type === 'error') { bgColor = 'bg-red-500'; icon = '❌'; }

            toast.innerHTML = `<span class="mr-2">${icon}</span>${message}`;
            toast.className = `p-3 rounded-xl shadow-2xl text-white ${bgColor} transition-all duration-300 transform translate-x-full opacity-0`;
            
            container.appendChild(toast);

            // Fade in and slide in
            setTimeout(() => {
                toast.style.transform = 'translate-x-0';
                toast.style.opacity = 1;
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                toast.style.transform = 'translate-x-full';
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 更新驗證狀態的 UI
        function updateAuthStatusUI(loggedIn, uid = null) {
            const container = document.getElementById('auth-status-container');
            if (loggedIn && uid) {
                // 已登入: 顯示部分 UID 和登出按鈕
                const displayUid = `${uid.substring(0, 4)}...${uid.substring(uid.length - 4)}`;
                container.innerHTML = `
                    <span class="text-xs text-gray-500 hidden sm:inline">科學家 ID:</span>
                    <span class="font-mono text-xs text-blue-600 p-1 bg-blue-100 rounded-lg shadow-inner">${displayUid}</span>
                    <button onclick="handleLoginLogout()" class="text-red-500 hover:text-red-700 text-xs ml-2 py-1 px-2 rounded-full hover:bg-red-50 transition duration-150">登出</button>
                `;
            } else {
                // 未登入: 顯示登入按鈕
                container.innerHTML = `
                    <button onclick="handleLoginLogout()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-sm">
                        👤 登入
                    </button>
                `;
            }
        }

        // 登入/登出處理器
        async function handleLoginLogout() {
            if (!auth) {
                showToast("Firebase 服務尚未準備好。", "error");
                return;
            }

            if (auth.currentUser) {
                // 登出
                try {
                    await signOut(auth);
                    showToast("成功登出！下次見👋", "success");
                } catch (error) {
                    console.error("Logout Error:", error);
                    showToast("登出失敗，請檢查網路。", "error");
                }
            } else {
                // 登入 (使用 Custom Token 或匿名登入)
                try {
                    if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    showToast("成功登入！匿名科學家已連線。", "success");
                } catch (error) {
                    console.error("Login Error:", error);
                    showToast("登入失敗，請稍後再試。", "error");
                }
            }
        }

        // *** Firebase 認證與初始化 ***
        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or invalid. Skipping Firebase init.");
                    updateAuthStatusUI(false);
                    return;
                }
                
                // 1. 初始化 App 和服務
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. 設定 Auth 狀態監聽器
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        updateAuthStatusUI(true, userId);
                        isAuthReady = true;
                        // 當認證狀態改變時，重新載入當前文章以刷新按讚狀態
                        loadArticle(currentArticleId);
                    } else {
                        userId = null;
                        updateAuthStatusUI(false);
                        isAuthReady = true; // 即使登出，也認為認證流程完成
                        loadArticle(currentArticleId);
                    }
                });

                // 3. 初始登入 (使用 Custom Token 或匿名登入)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 4. 確保文章元數據在 Firestore 中存在 (只需執行一次)
                await ensureArticleMetadataExists();

            } catch (error) {
                console.error("Firebase 初始化或認證錯誤:", error);
                updateAuthStatusUI(false);
                showToast("連線失敗，請檢查網路。無法啟用登入與按讚功能。", "error");
            }
        }

        /**
         * 確保每篇文章在 Firestore 中都有一個計數器 (Metadata)。
         */
        async function ensureArticleMetadataExists() {
            for (const articleId of articleOrder) {
                const docRef = doc(db, ARTICLE_METADATA_PATH, String(articleId));
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        await setDoc(docRef, { likeCount: 0, title: articles[articleId].title }, { merge: true });
                    }
                } catch (error) {
                    console.error(`確保文章 ${articleId} 元數據失敗:`, error);
                }
            }
        }

        // *** Modal 相關功能 (不變) ***
        const feedbackModal = document.getElementById('feedback-modal');

        function openFeedbackModal() {
            const nameInput = document.getElementById('name');
            const nameLabel = document.getElementById('name-label');
            
            if (userId) {
                nameInput.value = `ID: ${userId}`;
                nameInput.placeholder = "已自動填入您的使用者 ID";
                nameInput.disabled = true;
                nameInput.classList.add('bg-gray-100');
                nameLabel.innerHTML = `您的暱稱 <span class="text-green-600 font-normal">(已自動填入，不可修改)</span>`;
            } else {
                nameInput.value = "";
                nameInput.placeholder = "例如：熱愛科學的同學";
                nameInput.disabled = false;
                nameInput.classList.remove('bg-gray-100');
                nameLabel.innerHTML = `您的暱稱 (選填)`;
            }

            feedbackModal.classList.remove('hidden');
            feedbackModal.classList.add('flex');
            const content = feedbackModal.querySelector('div');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function closeFeedbackModal() {
            const content = feedbackModal.querySelector('div');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                feedbackModal.classList.remove('flex');
                feedbackModal.classList.add('hidden');
            }, 300);
        }

        function sendFeedback() {
            const nameInput = document.getElementById('name');
            const suggestion = document.getElementById('suggestion').value.trim();
            const rawName = nameInput.value.trim();

            if (suggestion === "") {
                showToast("請至少填寫建議內容！", "error");
                return;
            }

            const senderName = userId ? `已登入 ID: ${userId}` : (rawName || "匿名讀者");
            const subject = encodeURIComponent(`老董科學 - 網站改進建議 (${senderName})`);
            
            const bodyContent = `
老董您好，

我對「老董科學」網站的建議如下：
==================================================

${suggestion}

==================================================
感謝您的創作！

寄件人資訊: ${senderName}
文章 ID: ${currentArticleId}
            `.trim();
            
            const body = encodeURIComponent(bodyContent);
            const mailtoLink = `mailto:${USER_EMAIL}?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
            
            setTimeout(closeFeedbackModal, 100);
        }

        // *** 文章內容定義 (保持靜態內容) ***
        const articles = {
            1: {
                title: "萬有理論：終極物理的兩大難題",
                subtitle: "一個單一的數學框架，能解釋宇宙的一切嗎？",
                content: `<div class="space-y-6 text-gray-700">
                        <p class="text-lg font-medium">萬有理論，是所有科學家的夢想，是物理學的終極目標。它的目標是找到一個單一的、終極的、優雅的數學框架（或一組方程式），用來統一描述我們宇宙中所有的基本作用力和所有的物質。宇宙間發生的一切，從宇宙大爆炸到你手上的手機運作，都可以用這套理論來解釋......這絕對非常難，但...到底難在哪？</p>
                        <h3 class="text-2xl font-bold text-red-600 border-b pb-1">難點 1：宏觀 vs. 微觀的矛盾</h3>
                        <p>在 1969 年，科學家提出了四大力：引力、電磁力、強核力、弱核力。他們是這個世界運作的原則，他們主要由 <strong>2 個理論</strong> 說明：</p>
                        <ol class="list-decimal list-inside ml-4 space-y-2">
                            <li><span class="font-semibold text-blue-700">宏觀世界（重力）：</span> 由愛因斯坦的「廣義相對論」主宰，它說:
                                <ul class="list-disc list-inside ml-4"><li>宇宙是連續的 (不會斷斷續續)</li><li>引力是虛假的，只是時間和空間的扭曲</li></ul>
                            </li>
                            <li><span class="font-semibold text-green-700">微觀世界（其他三力）：</span> 由「量子力學」主宰，它說: 
                                <ul class="list-disc list-inside ml-4"><li>宇宙是斷斷續續的 (不會連續)</li><li>引力是真實的，就是粒子之間的傳遞</li></ul>
                            </li>
                        </ol>
                        <p class="font-bold text-xl text-yellow-600 bg-yellow-50 p-3 rounded-lg border border-yellow-200">發現了嗎? 兩者非常矛盾，要提出萬有理論，就必須克服這兩點。</p>
                        <h3 class="text-2xl font-bold text-red-600 border-b pb-1">難點 2：引力的弱小</h3>
                        <p>在微觀的粒子尺度上，引力是弱到不可思議的。</p>
                        <p>還記得磁鐵吸迴紋針吧! 小小一塊就可以吸起 5~10 根迴紋針，但迴紋針往下掉的是誰? 是整顆地球啊！這意味著一塊小磁鐵就可以抵過 <strong>10 顆地球</strong> 的引力！！（這就是引力，一個「超級虛弱」的大力士！）</p>
                        <p>因為引力在微觀尺度上太弱了，我們幾乎無法在實驗室中測量它的量子效應。我們甚至從未探測到理論上傳遞引力的粒子——「引力子」，這讓科學家難以證明許多理論是不是對的。</p>
                        <hr class="my-6 border-blue-200">
                        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                            <p class="font-bold text-blue-700">老董總結：</p>
                            <p>總而言之，現在科學界只要把引力和其他 3 種力統一就可以了，但這是非常困難的。期待哪天科學變得更發達，才能讓我們看見這個世界的真理。</p>
                            <p class="mt-2 text-sm text-gray-500">下一篇文章將告訴你科學家想出了哪些理論，以解決目前遇到的問題，請關注「老董科學」在「老」之前搞「董」!</p>
                        </div>
                    </div>`
            },
            2: {
                title: "宇宙設計圖之戰：迴圈量子引力 vs. 弦理論",
                subtitle: "是「樂高宇宙」還是「吉他宇宙」？兩大統一理論的終極對決！",
                content: `<div class="space-y-6">
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p>大家好！歡迎來到「老董辯論場」，上次我們聊到了萬有理論，它希望透過一條公式來解釋這世界運行的規則，但因為引力太弱、規則不合群，所以這條公式難以實現。今天就讓我們邀請兩位科學家來解決這些疑難雜症吧！讓我們歡迎…量子學家和…弦學家！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-quantum"><p class="font-bold text-indigo-700">量子學家：</p><p>聽聽我們的「迴圈量子引力」，因為引力太弱，也就是說它不合群，那我們就說只有引力合群，其他看似合群的全部都不合群，這就是所謂的「最不合群的不合群就是最合群」😎 <span class="text-sm text-gray-500">(拍手聲)</span></p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-string"><p class="font-bold text-pink-700">弦學家：</p><p>矛盾了，你說不合群最好，那你還讓引力合群。聽聽我們的「弦理論」，這四種力沒有一個合群，真正合群的是弦，它構成了所有的力！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p>好，精彩的繞口令，請停止😅</p></div>
                        <h3 class="text-xl font-extrabold text-gray-800 pt-4 border-b border-gray-300 pb-1">⚡ 回合一：時空的本質 (解決連續 vs. 離散的矛盾)</h3>
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p>量子學家，您提到電腦。但牛頓和愛因斯坦都把時空視為連續的布料。請問，您的「迴圈量子引力」是如何解決時空到底是「連續」還是「像積木一樣離散」這個最大的矛盾？</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-quantum"><p class="font-bold text-indigo-700">量子學家：</p><p>簡單！我們直接把時空「數位化」。人類最成功的發明是電腦，所以這個世界應該像電腦一樣，有像素、有幀數！</p><p class="mt-2 text-indigo-600 font-semibold">我們的核心主張是： 空間和時間都是由最小、最小的「時空積木」編織而成的迴圈網絡。時空不是一塊連續的布，而是一堆樂高。引力就是這張樂高網絡的幾何形狀。我們直接讓時空遵守了量子力學「不連續」的規則，矛盾迎刃而解！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-string"><p class="font-bold text-pink-700">弦學家：</p><p>就算是「量」子「力」學也應該「量力」而為，這個世界是電腦嗎！世界是由弦組成的。</p><p class="mt-2 text-pink-600 font-semibold">我的反擊是： 我們不需要把時空變成樂高！我們用一條弦來解決一切。這四種力，就像是一把吉他上的不同音符。弦用這種方式振動，產生電磁力；換一種方式振動，產生強核力；用一種特殊的振動方式，就產生了引力。所有的力都來自同一根弦，這才是真正的優雅統一！</p></div>
                        <h3 class="text-xl font-extrabold text-gray-800 pt-4 border-b border-gray-300 pb-1">🛡️ 回合二：維度的爭議與驗證 (解決引力太弱的難點)</h3>
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p>兩位都提出了各自美麗的理論。但弦學家，您的理論需要 10 個維度才能成立，我們只看到 4 個！您要如何證明那多出來的 6 個維度不是憑空想像？</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-string"><p class="font-bold text-pink-700">弦學家：</p><p>這 6 個維度當然不是憑空想像！它們只是「捲起來了」。</p><p class="mt-2 text-pink-600 font-semibold">我們的解釋是： 想像一根水管。遠遠看，它只有長度（一維）。但靠近看，你會發現它有環繞的寬度。那 6 個維度就是以這種方式極其微小地捲曲，所以我們感受不到。但只有這 10 個維度齊全，我們才能消除引力計算時產生的所有數學錯誤！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-quantum"><p class="font-bold text-indigo-700">量子學家：</p><p class="italic text-gray-500">(不屑地笑)</p><p>10 維！這就是你們的弱點！你們為了讓數學成立，就得假設一個無法被證明的夢想世界！</p><p class="mt-2 text-indigo-600 font-semibold">我們的優勢是： 「迴圈量子引力」只需要我們現實中看到的 4 個維度！我們比你們更貼近真實。如果有一天，我們能測量到時空像像素一樣「跳動」的極微小證據，我們就能證明 LQG。而你們的弦理論，可能永遠只能活在數學公式裡！</p></div>
                        <h3 class="text-xl font-extrabold text-gray-800 pt-4 border-b border-gray-300 pb-1">✨ 結語：老董的最終提問</h3>
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p>好，精彩的攻防！總而言之，迴圈量子引力試圖將時空數位化來修補矛盾，而弦理論則透過增加維度來重新定義宇宙。兩套理論都無法被完全證實。</p><p class="mt-2 font-bold">各位觀眾，你覺得哪一個理論更像是宇宙的「終極設計圖」呢？你喜歡簡約真實的 4 維「樂高宇宙」，還是優雅宏大的 10 維「吉他宇宙」？</p><p>在下方留言告訴我們。</p><p class="mt-2 text-sm text-gray-500">請關注「老董科學」在「老」之前搞「董」!</p></div>
                    </div>`
            },
            3: {
                title: "引力大戰！牛頓 vs. 愛因斯坦",
                subtitle: "到底是『力』，還是『時空扭曲』？一場世紀辯論！",
                content: `<!-- 辯論內容區塊 - 保持原來的樣式和結構 -->
                    <div class="space-y-6">
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">大家好，歡迎來到「老董辯論場」上次說到這個世界有4大力，分別是引力、電磁力、強核力及弱核力，今天我們就來聊聊引力吧，讓我們歡迎重力發明者—牛頓，和IQ180的愛因斯坦！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">我可是牛頓，這局你就輸定了</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">IQ180的人怎麼可能輸給一頭小牛呢</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">任何有質量的東西都有引力，質量越大引力就越大，距離越遠引力也越弱</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">「東西不會憑空出現或消失，力也是一樣」這句話是你自己說的，但一個有質量的物體卻可以憑空產生力，並把其他東西吸過來，這太扯了</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">東西吸東西是正常現象，地球上任何物體不是都會被地球吸，哪裡扯了，所有觀眾都可以為我驗證這件事，難道你有更好的說法嗎</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">當然有！東西會往下掉是因為「有質量的物體會扭曲引力場，造成空間扭曲和時間扭曲，而物體就在引力場和時空扭曲之下看起來就像是往下掉，但這只是錯覺」</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">抱歉潑你一把冷水，愛因「濕」坦，你把這世界說的好像科幻小說一樣，東西不會憑空出現或消失，但有質量的物體卻可以憑空產生重力場，還憑空扭曲時空，這樣講不是更矛盾嗎？</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">我的理論沒有問題，你的理論才奇怪，早就有科學家用你的公式去預測水星的移動路徑，結果算出來與實際觀測的不一樣，而用我的公式算就一模一樣，這證明了你的理論是錯的</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">不要轉移話題...解釋剛才我說的</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">我的理論並沒有「憑空」變出任何東西，它只是重新定義了物質的「存在方式」。在你的理論中，你必須假設一個額外的、看不見的、叫做「力」的媒介，才能讓地球和太陽互相拉扯。這個「力」才是真正的憑空出現。</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-newton"><p class="font-bold text-orange-700">牛頓：</p><p class="text-gray-700">.........</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-einstein"><p class="font-bold text-green-700">愛因斯坦：</p><p class="text-gray-700">你的引力是假設出來的力，我的引力是物質存在所必然產生的幾何結構。哪一個更像「科幻小說」，我想觀眾們自有公斷！</p></div>
                        <div class="p-4 rounded-lg shadow-md speaker-host"><p class="font-bold text-blue-700">老董：</p><p class="text-gray-700">真是一場精彩的對決！沒想到引力的發明者牛頓竟然輸給了愛因斯坦，那麼這次的勝利就獻給－愛因斯坦！記得關注「老董科學」在「老」之前搞「董」!</p></div>
                    </div>`
            },
            101: {
                title: "手指頭的極限：超進化進位制",
                subtitle: "從幼稚園到百萬大關，加法直式居然輸給了你的十根手指？",
                content: `<div class="space-y-6 text-gray-700">
                        <p class="text-lg font-medium">數字，是數學最重要的樑柱。有了數字，便有了加法，從單純的累加數字到瘋狂的泰勒級數，一切，就從加法開始。</p> 
                        <h3 class="text-xl font-bold text-green-600 border-b pb-1 mt-6">--- 等級一：幼兒園大班 (進位制：10) ---</h3>
                        <div class="pl-4 border-l-4 border-green-300 bg-green-50 p-3 rounded-lg"><p>幼兒園大班，我們學到了 5 以內的加法，老師會叫你搬出手指頭，2+3 就是左手比兩隻，右手比三隻，再算算你比的幾根手指頭，你會得到 5，而這就是答案。</p></div>
                        <h3 class="text-xl font-bold text-yellow-600 border-b pb-1 mt-6">--- 等級二：小學二年級 (進位制：10) ---</h3>
                        <div class="pl-4 border-l-4 border-yellow-300 bg-yellow-50 p-3 rounded-lg">
                            <p>小學二年級，我們學到了 100 以內的加法，因為數字太大了，老師會告訴你寫直式，看見黑板滿滿的數字，你有兩種選擇：</p>
                            <ol class="list-disc list-inside ml-4 mt-2"><li>接受它</li><li>繼續用手指頭</li></ol>
                            <p class="mt-2">回到正題，100 以內的加法已經沒辦法再用幼兒園的方式了。把幼兒園的方式稱為等級一，那這種就是等級二：</p>
                            <p>我要算 11+12，左手比 1(代表十位)，右手比 1(代表個位)接下來開始數 1, 2, 3 ... 每數一次手指頭就加 1。數 12 次後你就會得到 23。</p>
                            <p class="mt-2 text-sm italic">但這種方法最高只能數到 50+49 (用兩隻手數 99 次)。難道這就是手指頭的極限了嗎？「用進廢退」我們會有 10 根手指頭就代表我們需要。那手指頭的極限是幾，100、500 還是 1000？並不對，都更高。</p>
                        </div>
                        <h3 class="text-xl font-bold text-indigo-600 border-b pb-1 mt-6">--- 等級三：小學三年級 (進位制：2) ---</h3>
                        <div class="pl-4 border-l-4 border-indigo-300 bg-indigo-50 p-3 rounded-lg">
                            <p>小學三年級，我們學到了 1000 以內的數，但是我們能夠用手指頭數到 1000 嗎？</p>
                            <p>想像你有 10 根手指頭，第一隻寫 2^0 = 1、第二隻寫 2^1 = 2、第三隻寫 2^2 = 4 ... 第十隻寫 2^9 = 512。如果你要寫 1 就把第一隻豎起來，要寫 3 就把第一隻和第二隻豎起來，因為 1+2=3。</p>
                            <p class="mt-2 font-bold text-indigo-700">我們找找看這種方式的極限：</p>
                            <p>它的極限就是全部豎起來，那這樣是幾呢？</p>
                            <p class="text-center text-xl font-extrabold my-4">1+2+4+8+...+512 = 1023！</p>
                            <p>這個答案看起來非常厲害，但很快你就撐不下去了...</p>
                        </div>
                        <h3 class="text-xl font-bold text-red-600 border-b pb-1 mt-6">--- 等級四：小學四年級 (進位制：3，平衡三進制啟發) ---</h3>
                        <div class="pl-4 border-l-4 border-red-300 bg-red-50 p-3 rounded-lg">
                            <p>小學四年級，我們學到了一萬以內的數，但手指頭只能數到 1023，完全不夠用，被加法直式逼入絕境的你，想出了無人能敵的方法。</p>
                            <h4 class="font-extrabold text-lg mt-4 text-red-700">--- 前方高能 (變形進位制) ---</h4>
                            <p class="mt-2">手指頭有<strong>不豎起來</strong>和<strong>豎起來</strong> (2種狀態，二進制)，但也可以有<strong>豎一半</strong>！</p>
                            <p class="mt-2">把每根手指分成 <strong>不豎起來 (0)</strong>、<strong>豎一半 (1)</strong>、<strong>全豎 (2)</strong> (3種狀態，三進制)。</p>
                            <p>第一隻手寫 3^0=1、第二隻寫 3^1=3、第三隻寫 3^2=9... 第十隻寫 3^9=19683。</p>
                            <p>如果用 10 根手指頭（N=10），它的極限是：</p>
                            <p class="text-center text-xl font-extrabold my-4">2 x (1+3+...+3^9) = 3^10 - 1 = 59048！<span class="text-base font-normal">(約 6 萬)</span></p>
                            <p class="mt-4">但這是極限嗎? 不！</p>
                            <p>把手指頭分成 5 種狀態 (五進制)，可以數到 5^10 - 1 = 9765624 (1 千萬)！</p>
                            <p>...要數到幾都沒問題，只要你的眼睛夠利，因此，手指頭是<strong>沒有極限</strong>的。</p>
                        </div>
                        <hr class="my-6 border-blue-200">
                        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                            <p class="font-bold text-blue-700">老董總結：</p>
                            <p>你知道嗎？最後兩種方法竟然跟我們電腦運算的 <strong>進位制</strong> 有關，還可以拿來轉換！</p>
                            <p class="mt-2">以後考試遇到加法時，只有你沒有用直式，你就可以和老師說：</p>
                            <p class="mt-2 text-center text-xl font-extrabold text-gray-800">「我沒有作弊，只是對數字做了一點『手術 (手指運算術)』」</p>
                        </div>
                    </div>`
            },
            102: {
                title: "除以零的危機：為什麼無解？",
                subtitle: "數學的禁令：除以零會摧毀邏輯",
                content: `<div class="space-y-6 text-gray-700">
                    <div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <p class="font-bold text-lg">小白: 10除以0等於多少</p>
                        <p class="font-bold text-indigo-700">老董：除以零是個數學上無意義的操作</p>
                        <p class="mt-2">小白：但不是只是無意義就沒了，哪裡不對了</p>
                    </div>
                    
                    <div class="pl-4 border-l-4 border-green-300 bg-green-50 p-3 rounded-lg">
                        <p>你想想看，10 ÷ 5 就是把 10 顆蘋果分給 5 個人，一個人可以得到 2 顆蘋果。</p>
                        <p>這代表：10 ÷ 0 就是把 10 顆蘋果分給 0 個人，但都沒有人了，你是要分什麼？</p>
                        <p>因此…此題無解。</p>
                    </div>
                

                    <div class="pl-4 border-l-4 border-blue-300 bg-blue-50 p-3 rounded-lg">
                        <p>小白：等等，分蘋果？會不會太「不數學」了</p>
                        <p>好的，我用你小學學過的數學說明：</p>
                        <p>10 ÷ 5 = 2，5 × 2 = 10，因此 10 ÷ 0 = ??，0 × ?? = 10，但是任何數乘 0 都是 0</p>
                        <p>因此…此題無解。</p>
                    </div>

                    <div class="pl-4 border-l-4 border-purple-300 bg-purple-50 p-3 rounded-lg">
                        <p>小白：無解無解都給你無解就好了！說不定 ?? × 0 真的是 10 啊！?? 他就是那麼神奇啊！</p>
                        <p>老董：好，假設 ?? × 0 真的是 10，來看會發生什麼事：</p>
                        <ol class="list-decimal list-inside ml-4 mt-2">
                            <li>從 1×0 = 10×0（同時乘以 0）開始。</li>
                            <li>對等式兩邊做相同的運算（例如 ÷0），變成：</li>
                            <li>1×0÷0=10×0÷0，把10×0位置交換，變成：</li>
                            <li>1×0÷0=0×10÷0，前面說10÷0=??，變成：</li>
                            <li>1×0÷0=0×??， 前面說0×??是10，變成：</li>
                            <li>1×0÷0=10，把×0÷0消掉，變成：</li>
                            <li>1=10，但這肯定是不對的！</li>
                        </ol>
                        <p class="mt-2">因此...此題無解！</p>
                    </div>

                    <div class="pl-4 border-l-4 border-red-300 bg-red-50 p-3 rounded-lg">
                        <p>小白：一定有其它方法…分數！除法可以轉成分數！</p>
                        <p>老董：好的，用分數證明除以0是錯誤的</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>1 ÷ 1 = 1</li>
                            <li>1 ÷ 0.001 = 1000</li>
                            <li>1 ÷ 0.0000001 = 10000000</li>
                        </ul>
                        <p>當除數越接近0十，數值就越大，這意味著如果我們除以0，值就是∞</p>
                        <p class="mt-2">但是!</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>-1 ÷ 1 = -1</li>
                            <li>-1 ÷ 0.001 = -1000</li>
                            <li>-1 ÷ 0.0000001 = -10000000</li>
                        </ul>
                        <p>當除數越接近0時，值就越小，這意味著如果我們除以0，值就是 -∞</p>
                        <p class="mt-2">發現了嗎</p>
                        <p>一個說是∞，一個說是-∞，但∞不可能等於-∞</p>
                        <p>因此...此題無解！！</p>
                    </div>

                    <div class="p-4 rounded-lg bg-yellow-50 border-l-4 border-yellow-300">
                        <p class="font-bold">結論：</p>
                        <p>數學雖然看似自由，但其中也藏著向除以0那樣危險的東西</p>
                        <p>數學系統建立在嚴謹的邏輯和公理之上。除以零的無意義性，不是因為我們找不到答案，而是因為如果我們允許它存在，整個數學大廈的根基就會被矛盾和不確定性所摧毀。</p>
                        <p>因此，除以零並非只是「無解」，它是一個會導致邏輯崩潰的運算，是我們為了保護數學世界的完整性和可靠性所設下的最重要的一條禁令。</p>
                        <p class="mt-2">小白：等著看，下一篇我一定會來反擊的。</p>
                    </div>
                </div>`
            },
        };

        let currentArticleId = 101; // 預設載入最新的文章
        const mainContentEl = document.getElementById('main-content');
        const subtitleEl = document.getElementById('article-subtitle');

        // ----------------------------------------------------
        // 按讚功能實作
        // ----------------------------------------------------

        /**
         * 處理按讚/取消按讚的交易邏輯。
         * @param {number} articleId - 文章的 ID。
         * @param {boolean} isLiked - 目前使用者是否已按讚。
         */
        async function toggleLike(articleId, isLiked) {
            if (!isAuthReady || !userId || !db) {
                showToast("登入中或初始化中...請稍候再試。", "info");
                return;
            }

            const articleStrId = String(articleId);
            const articleRef = doc(db, ARTICLE_METADATA_PATH, articleStrId);
            const likeId = `${articleStrId}_${userId}`;
            const likeRef = doc(db, USER_LIKES_PATH, likeId);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. 取得當前的文章資料
                    const articleSnap = await transaction.get(articleRef);
                    if (!articleSnap.exists()) {
                        throw new Error("文章不存在，無法計數！");
                    }

                    const currentCount = articleSnap.data().likeCount || 0;
                    let newCount = currentCount;

                    if (isLiked) {
                        // 執行取消按讚
                        newCount = Math.max(0, currentCount - 1); // 確保讚數不為負
                        transaction.update(articleRef, { likeCount: newCount });
                        transaction.delete(likeRef);
                        showToast("已取消按讚！", "success");
                    } else {
                        // 執行按讚
                        newCount = currentCount + 1;
                        transaction.update(articleRef, { likeCount: newCount });
                        transaction.set(likeRef, { 
                            articleId: articleStrId, 
                            userId: userId, 
                            timestamp: new Date().toISOString() 
                        });
                        showToast("成功按讚！謝謝您的支持！", "success");
                    }
                });
            } catch (err) {
                console.error("按讚操作失敗:", err);
                showToast(`按讚操作失敗: ${err.message || '請檢查連線或權限'}`, "error");
            }
        }

        /**
         * 建立並監聽當前文章的按讚狀態。
         * @param {number} articleId - 當前文章的 ID。
         */
        function setupLikeListener(articleId) {
            // 先清除舊的監聽器
            if (articleLikeUnsub) articleLikeUnsub();
            if (userLikeUnsub) userLikeUnsub();

            if (!isAuthReady || !db) return;

            const articleStrId = String(articleId);
            const likeSectionEl = document.getElementById('like-section');
            if (!likeSectionEl) return;

            let currentLikeCount = 0;
            let userHasLiked = false;

            // 1. 監聽文章的總按讚數
            const articleRef = doc(db, ARTICLE_METADATA_PATH, articleStrId);
            articleLikeUnsub = onSnapshot(articleRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentLikeCount = docSnap.data().likeCount || 0;
                } else {
                    currentLikeCount = 0;
                }
                renderLikeButton();
            }, (error) => {
                console.error("文章總讚數監聽失敗:", error);
                likeSectionEl.innerHTML = `<span class="text-red-500">無法載入按讚數</span>`;
            });

            // 2. 監聽當前使用者的按讚狀態
            if (userId) {
                const likeId = `${articleStrId}_${userId}`;
                const userLikeRef = doc(db, USER_LIKES_PATH, likeId);
                
                userLikeUnsub = onSnapshot(userLikeRef, (docSnap) => {
                    userHasLiked = docSnap.exists();
                    renderLikeButton();
                }, (error) => {
                    console.error("使用者按讚狀態監聽失敗:", error);
                });
            } else {
                userHasLiked = false;
                renderLikeButton();
            }

            /**
             * 根據最新狀態渲染按讚按鈕。
             */
            function renderLikeButton() {
                const btnClass = userHasLiked 
                    ? 'bg-red-500 text-white shadow-xl liked-active' 
                    : 'bg-gray-100 text-gray-500 hover:bg-red-500 hover:text-white shadow-md';
                const icon = userHasLiked ? '❤️' : '🤍';
                const text = userHasLiked ? '已按讚' : '按讚';
                
                likeSectionEl.innerHTML = `
                    <div class="flex items-center space-x-6">
                        <span class="text-2xl font-extrabold text-gray-700">${currentLikeCount}</span>
                        <span class="text-gray-500 text-lg">個讚</span>
                        
                        <button onclick="toggleLike(${articleId}, ${userHasLiked})" 
                                class="like-button flex items-center space-x-2 py-2 px-6 rounded-full transition duration-300 transform hover:scale-105 ${btnClass}">
                            <span class="text-2xl leading-none">${icon}</span>
                            <span class="font-bold text-lg">${text}</span>
                        </button>
                        
                    </div>
                `;
            }
        }


        // *** 文章內容定義與切換邏輯 ***
        
        /**
         * 根據 ID 載入並顯示文章內容
         * @param {number} id - 文章 ID
         */
        function loadArticle(id) {
            id = parseInt(id); // 確保是數字
            window.scrollTo(0, 0); // 載入新文章時，滾動到頁面頂部

            if (!articles[id]) {
                mainContentEl.innerHTML = `<div class="p-6 text-center text-red-500 bg-red-50 rounded-lg">找不到文章 ID: ${id}</div>`;
                subtitleEl.textContent = "文章載入錯誤";
                return;
            }

            // 1. 處理下一篇文章按鈕
            const currentIndex = articleOrder.indexOf(id);
            const nextId = articleOrder[currentIndex + 1];
            let nextButtonHtml = '';

            if (nextId) {
                const nextArticleTitle = articles[nextId].title;
                nextButtonHtml = `
                    <div class="flex justify-end mt-12 pt-4 border-t border-blue-200">
                        <button onclick="loadArticle(${nextId})"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-xl transition duration-300 transform hover:scale-105 flex items-center space-x-2">
                            <span>【下一篇】</span>
                            <span class="font-normal text-sm sm:text-base">${nextArticleTitle}</span>
                            <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </button>
                    </div>
                `;
            } else {
                nextButtonHtml = `
                    <div class="mt-12 pt-4 border-t border-blue-200 text-center text-gray-500 font-medium">
                        🥳 恭喜！您已閱讀完目前所有連載文章。請期待老董的下一篇大作！
                    </div>
                `;
            }

            // 2. 組合主內容、按讚區塊和下一篇按鈕
            const article = articles[id];
            
            // 加入新的按讚容器
            const fullContent = `
                ${article.content}
                
                <div class="mt-8 pt-6 border-t-4 border-dashed border-gray-200">
                    <h4 class="text-xl font-bold text-indigo-600 mb-4">喜歡這篇文章嗎？按個讚吧！</h4>
                    <div id="like-section" class="py-4 px-6 bg-indigo-50 rounded-xl shadow-inner flex justify-center sm:justify-start">
                        <!-- 按讚按鈕與計數器將在此處由 setupLikeListener 載入 -->
                        <div class="text-gray-500">載入按讚狀態...</div>
                    </div>
                </div>

                ${nextButtonHtml}
            `;
            
            // 漸出效果
            mainContentEl.style.opacity = 0;
            setTimeout(() => {
                // 注入內容和下一篇按鈕
                mainContentEl.innerHTML = fullContent;
                subtitleEl.textContent = article.subtitle;
                currentArticleId = id;

                // 3. 更新側邊欄活躍狀態
                document.querySelectorAll('.article-link').forEach(link => {
                    link.classList.remove('active');
                });
                const activeLink = document.getElementById(`link-${id}`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }

                // 4. 設定文章載入後的即時按讚監聽器
                if (isAuthReady) {
                    setupLikeListener(id);
                }

                // 5. 漸入效果
                mainContentEl.style.opacity = 1;
            }, 200); // 200 毫秒延遲
        }

        // 頁面載入完成後，執行初始化和載入預設文章
        window.onload = function() {
            // 1. 初始化 Firebase 和驗證
            initializeFirebaseAndAuth(); 

            // 2. 載入文章
            mainContentEl.style.transition = 'opacity 0.2s ease-in-out';
            loadArticle(currentArticleId); 
        };
        
        // 將這些函數附加到 window，使其能在 HTML 內聯事件中被呼叫
        window.openFeedbackModal = openFeedbackModal;
        window.closeFeedbackModal = closeFeedbackModal;
        window.sendFeedback = sendFeedback;
        window.loadArticle = loadArticle;
        window.handleLoginLogout = handleLoginLogout;
        window.toggleLike = toggleLike; // 暴露給 HTML 呼叫

    </script>
</body>
</html>
